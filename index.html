<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>小七记账 - 手机端</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            padding-bottom: 100px;
        }

        /* 礼花动画 */
        @keyframes fireworks {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        .firework {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #ffd700;
            border-radius: 50%;
            animation: fireworks 0.8s ease-out forwards;
            z-index: 999;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 15px;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .welcome-text {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 10px;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stat-item {
            text-align: center;
            flex: 1;
            min-width: 80px;
        }

        .stat-item .label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .stat-item .value {
            font-size: 18px;
            font-weight: bold;
        }

        .income { color: #4cd964; }
        .expense { color: #ff6b6b; }
        .balance { color: #fff; }

        .today-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        /* 连续打卡 */
        .streak-card {
            background: white;
            margin: 15px;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .streak-title {
            font-size: 14px;
            color: #666;
        }
        .streak-day {
            font-size: 30px;
            font-weight: bold;
            color: #667eea;
            margin: 5px 0;
        }

        /* 月度总结 */
        .month-card {
            background: white;
            margin: 15px;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .month-title {
            font-weight: bold;
            margin-bottom: 8px;
        }
        .month-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 14px;
        }

        /* 快捷分类 */
        .quick-category {
            display: flex;
            gap: 8px;
            margin: 0 15px 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        .quick-btn {
            padding: 8px 12px;
            background: white;
            border: 1px solid #eee;
            border-radius: 20px;
            font-size: 13px;
            white-space: nowrap;
        }
        .quick-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .chart-container {
            background: white;
            margin: 15px;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .chart-title {
            font-size: 16px;
            margin-bottom: 10px;
            font-weight: bold;
            text-align: center;
        }
        #trendChart {
            width: 100%;
            height: 200px;
        }

        .achievements {
            background: white;
            margin: 15px;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .achievements-title {
            font-size: 16px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .badge-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .badge {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-size: 10px;
            background: #e0e0e0;
            color: #666;
        }
        .badge.unlocked {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4b 100%);
            color: #333;
        }

        .tip-container {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            margin: 15px;
            padding: 15px;
            border-radius: 15px;
            color: white;
        }

        .form-container {
            background: white;
            margin: 15px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .form-group { margin-bottom: 15px; }
        .form-group label {
            font-size: 14px;
            margin-bottom: 8px;
            display: block;
            color: #666;
        }
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }
        .type-selector {
            display: flex;
            gap: 10px;
        }
        .type-btn {
            flex: 1;
            padding: 12px;
            text-align: center;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
        }
        .type-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .func-buttons {
            display: flex;
            margin: 0 15px 15px;
            gap: 10px;
        }
        .func-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 10px;
        }

        .date-search {
            background: white;
            margin: 0 15px 15px;
            padding: 15px;
            border-radius: 15px;
            display: flex;
            gap: 10px;
        }
        .date-search input { flex:1; padding:10px; }
        .date-search button {
            padding: 10px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
        }

        .list-container { margin: 0 15px; }
        .list-title {
            font-size: 16px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .bill-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        .bill-item:hover { transform: translateY(-3px); }
        .empty-tip { text-align: center; padding:30px; color:#999; }
    </style>
</head>
<body>

<div class="header">
    <div class="welcome-text" id="welcomeText"></div>
    <h1>小七记账</h1>
    <div class="stats">
        <div class="stat-item">
            <div class="label">总收入</div>
            <div class="value income" id="totalIncome">¥0.00</div>
        </div>
        <div class="stat-item">
            <div class="label">总支出</div>
            <div class="value expense" id="totalExpense">¥0.00</div>
        </div>
        <div class="stat-item">
            <div class="label">结余</div>
            <div class="value balance" id="totalBalance">¥0.00</div>
        </div>
    </div>
    <div class="today-stats">
        <div class="stat-item">
            <div class="label">今日收入</div>
            <div class="value income" id="todayIncome">¥0.00</div>
        </div>
        <div class="stat-item">
            <div class="label">今日支出</div>
            <div class="value expense" id="todayExpense">¥0.00</div>
        </div>
    </div>
</div>

<!-- 连续打卡 -->
<div class="streak-card">
    <div class="streak-title">📅 记账连续天数</div>
    <div class="streak-day" id="streakDay">0</div>
    <div style="font-size:12px;color:#999">坚持记账，越记越有钱～</div>
</div>

<!-- 月度总结 -->
<div class="month-card">
    <div class="month-title">本月概况</div>
    <div class="month-row">
        <span>本月收入</span>
        <span class="income" id="monthIncome">¥0.00</span>
    </div>
    <div class="month-row">
        <span>本月支出</span>
        <span class="expense" id="monthExpense">¥0.00</span>
    </div>
    <div class="month-row">
        <span>本月结余</span>
        <span style="font-weight:bold" id="monthBalance">¥0.00</span>
    </div>
</div>

<div class="chart-container">
    <div class="chart-title">近7天收支趋势</div>
    <canvas id="trendChart"></canvas>
</div>

<div class="achievements">
    <div class="achievements-title">我的记账成就</div>
    <div class="badge-list" id="badgeList"></div>
</div>

<div class="tip-container">
    <div class="tip-title">💡 今日小建议</div>
    <div class="tip-content" id="tipContent"></div>
</div>

<div class="date-search">
    <input type="date" class="form-control" id="searchDate">
    <button id="searchBtn">查询</button>
</div>

<!-- 快捷分类 -->
<div class="quick-category" id="quickCategory">
    <div class="quick-btn" data-name="餐饮">🍽 餐饮</div>
    <div class="quick-btn" data-name="购物">🛍 购物</div>
    <div class="quick-btn" data-name="交通">🚗 交通</div>
    <div class="quick-btn" data-name="娱乐">🎮 娱乐</div>
    <div class="quick-btn" data-name="红包">🧧 红包</div>
    <div class="quick-btn" data-name="工资">💰 工资</div>
</div>

<div class="form-container">
    <div class="form-group">
        <label>交易类型</label>
        <div class="type-selector">
            <div class="type-btn active" data-type="expense">支出</div>
            <div class="type-btn" data-type="income">收入</div>
        </div>
    </div>

    <div class="form-group">
        <label>金额 (元)</label>
        <input type="number" class="form-control" id="amount" step="0.01">
    </div>
    <div class="form-group">
        <label>备注</label>
        <input type="text" class="form-control" id="remark" placeholder="自动填充分类">
    </div>
    <div class="form-group">
        <label>日期</label>
        <input type="date" class="form-control" id="date">
    </div>
    <button class="btn" id="addBill">添加账单</button>
</div>

<div class="func-buttons">
    <button class="func-btn" id="importBtn">导入</button>
    <button class="func-btn" id="exportBtn">导出</button>
    <button class="func-btn" id="shareBtn">分享</button>
</div>
<input type="file" id="fileInput" accept=".json" style="display:none">

<div class="list-container">
    <div class="list-title">最近账单</div>
    <div id="billList"></div>
</div>

<script>
let bills = JSON.parse(localStorage.getItem('bills')) || [];
let editIndex = -1;

const tips = [
    "早餐吃好，一天精神～",
    "少喝一杯奶茶，多存一笔钱",
    "记账让你更懂钱",
    "冲动消费先等24小时",
    "小钱不记，大钱不留"
];

document.addEventListener('DOMContentLoaded', function(){
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;
    document.getElementById('searchDate').value = today;
    initWelcome();
    initTip();
    bindAll();
    renderList();
    updateStats();
    updateMonth();
    updateStreak();
    renderChart();
    renderBadges();
    searchByDate(today);
});

// 礼花动效
function fire(){
    for(let i=0;i<12;i++){
        let f = document.createElement('div');
        f.className = 'firework';
        f.style.left = Math.random()*100 + 'vw';
        f.style.top = Math.random()*100 + 'vh';
        f.style.background = ['#ffd700','#ff6b6b','#4cd964','#2196f3'][Math.floor(Math.random()*4)];
        document.body.appendChild(f);
        setTimeout(()=>f.remove(), 800);
    }
}

function initWelcome(){
    const h = new Date().getHours();
    let t = "欢迎使用小七记账～";
    if(h>=5&&h<10) t="☀️ 早上好！";
    else if(h<14) t="☀️ 上午好！";
    else if(h<18) t="🌤 下午好！";
    else t="🌙 晚上好！";
    document.getElementById('welcomeText').textContent = t;
}

function initTip(){
    document.getElementById('tipContent').textContent = tips[Math.floor(Math.random()*tips.length)];
}

function bindAll(){
    // 类型
    document.querySelectorAll('.type-btn').forEach(b=>{
        b.onclick = ()=>{
            document.querySelectorAll('.type-btn').forEach(x=>x.classList.remove('active'));
            b.classList.add('active');
        }
    });
    // 快捷分类
    document.querySelectorAll('.quick-btn').forEach(b=>{
        b.onclick = ()=>{
            document.getElementById('remark').value = b.dataset.name;
        }
    });
    // 添加
    document.getElementById('addBill').onclick = saveBill;
    // 导入导出分享
    document.getElementById('importBtn').onclick = ()=>document.getElementById('fileInput').click();
    document.getElementById('fileInput').onchange = importBill;
    document.getElementById('exportBtn').onclick = exportBill;
    document.getElementById('shareBtn').onclick = share;
    // 查询
    document.getElementById('searchBtn').onclick = ()=>searchByDate(document.getElementById('searchDate').value);
}

function saveBill(){
    const type = document.querySelector('.type-btn.active').dataset.type;
    const amount = parseFloat(document.getElementById('amount').value);
    const remark = document.getElementById('remark').value || "未分类";
    const date = document.getElementById('date').value;
    if(!amount || amount<=0 || !date) return alert("请填写完整信息");
    
    const bill = {
        id:Date.now(), type, amount, remark, date
    };
    
    if(editIndex===-1) bills.unshift(bill);
    else { bills[editIndex] = bill; editIndex=-1; }
    
    localStorage.setItem('bills', JSON.stringify(bills));
    resetForm();
    renderList();
    updateStats();
    updateMonth();
    updateStreak();
    renderChart();
    renderBadges();
    searchByDate(date);
    fire();
    alert("保存成功！");
}

function resetForm(){
    document.getElementById('amount').value = '';
    document.getElementById('remark').value = '';
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
    document.querySelectorAll('.type-btn').forEach(b=>b.classList.remove('active'));
    document.querySelector('[data-type="expense"]').classList.add('active');
}

function renderList(filter=null){
    const arr = filter || bills;
    const el = document.getElementById('billList');
    if(arr.length===0){ el.innerHTML = '<div class="empty-tip">暂无记录</div>'; return; }
    let html = '';
    arr.forEach((b,i)=>{
        const idx = filter ? bills.findIndex(x=>x.id===b.id) : i;
        html += `
        <div class="bill-item">
            <div style="display:flex;align-items:center">
                <div>
                    <div style="font-size:12px;color:#999">${b.remark}</div>
                    <div style="font-size:12px;color:#ccc">${b.date}</div>
                </div>
            </div>
            <div style="font-weight:bold" class="${b.type=='income'?'income':'expense'}">
                ${b.type=='income'?'+':'-' }¥${b.amount.toFixed(2)}
            </div>
        </div>`;
    });
    el.innerHTML = html;
}

function updateStats(){
    let inAll=0, outAll=0, inToday=0, outToday=0;
    const today = new Date().toISOString().split('T')[0];
    bills.forEach(b=>{
        if(b.type=='income') inAll+=b.amount; else outAll+=b.amount;
        if(b.date==today){
            if(b.type=='income') inToday+=b.amount; else outToday+=b.amount;
        }
    });
    document.getElementById('totalIncome').textContent = '¥'+inAll.toFixed(2);
    document.getElementById('totalExpense').textContent = '¥'+outAll.toFixed(2);
    document.getElementById('totalBalance').textContent = '¥'+(inAll-outAll).toFixed(2);
    document.getElementById('todayIncome').textContent = '¥'+inToday.toFixed(2);
    document.getElementById('todayExpense').textContent = '¥'+outToday.toFixed(2);
}

function updateMonth(){
    const now = new Date();
    const month = now.getMonth()+1;
    const year = now.getFullYear();
    let inM=0, outM=0;
    bills.forEach(b=>{
        const d = new Date(b.date);
        if(d.getFullYear()==year && d.getMonth()+1==month){
            if(b.type=='income') inM+=b.amount; else outM+=b.amount;
        }
    });
    document.getElementById('monthIncome').textContent = '¥'+inM.toFixed(2);
    document.getElementById('monthExpense').textContent = '¥'+outM.toFixed(2);
    document.getElementById('monthBalance').textContent = '¥'+(inM-outM).toFixed(2);
}

// 连续天数
function updateStreak(){
    const set = new Set();
    bills.forEach(b=>set.add(b.date));
    const days = Array.from(set).sort().reverse();
    let streak = 0;
    const today = new Date().toISOString().split('T')[0];
    if(days[0]==today){
        streak=1;
        for(let i=1;i<days.length;i++){
            const prev = new Date(days[i-1]);
            prev.setDate(prev.getDate()-1);
            const pStr = prev.toISOString().split('T')[0];
            if(pStr==days[i]) streak++;
            else break;
        }
    }
    document.getElementById('streakDay').textContent = streak;
}

function renderChart(){
    // 近7天趋势图
    const labels = [];
    const inData = [];
    const outData = [];
    for(let i=6;i>=0;i--){
        const d = new Date();
        d.setDate(d.getDate()-i);
        const ds = d.toISOString().split('T')[0];
        labels.push(d.getMonth()+1+'/'+d.getDate());
        let inSum=0, outSum=0;
        bills.forEach(b=>{
            if(b.date==ds){
                if(b.type=='income') inSum+=b.amount;
                else outSum+=b.amount;
            }
        });
        inData.push(inSum);
        outData.push(outSum);
    }
    const ctx = document.getElementById('trendChart').getContext('2d');
    if(window.chart) window.chart.destroy();
    window.chart = new Chart(ctx,{
        type:'line',
        data:{
            labels:labels,
            datasets:[
                { label:'收入', data:inData, borderColor:'#4cd964', backgroundColor:'rgba(76,217,100,0.1)', fill:true },
                { label:'支出', data:outData, borderColor:'#ff6b6b', backgroundColor:'rgba(255,107,107,0.1)', fill:true }
            ]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            scales:{ y:{ beginAtZero:true } }
        }
    });
}

function renderBadges(){
    const badgeEl = document.getElementById('badgeList');
    badgeEl.innerHTML = '';
    const list = [
        {name:'首笔记账',icon:'📝',ok:bills.length>=1},
        {name:'记账达人',icon:'🏆',ok:bills.length>=10},
        {name:'连续7天',icon:'📅',ok:document.getElementById('streakDay').textContent>=7},
        {name:'存钱小能手',icon:'💰',ok:(()=>{let i=0,o=0;bills.forEach(b=>b.type=='income'?i+=b.amount:o+=b.amount);return i-o>500})()},
    ];
    list.forEach(b=>{
        badgeEl.innerHTML += `
        <div class="badge ${b.ok?'unlocked':''}">
            <div style="font-size:20px">${b.icon}</div>
            <div>${b.name}</div>
        </div>`;
    });
}

function searchByDate(d){
    let inSum=0, outSum=0;
    const list = bills.filter(b=>b.date==d);
    list.forEach(b=>b.type=='income' ? inSum+=b.amount : outSum+=b.amount);
    document.getElementById('searchResult').textContent = `收入 ${inSum.toFixed(2)} 元，支出 ${outSum.toFixed(2)} 元`;
    renderList(list);
}

function importBill(e){
    const file = e.target.files[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = ev=>{
        try{
            const data = JSON.parse(ev.target.result);
            if(Array.isArray(data)){
                bills = data;
                localStorage.setItem('bills', JSON.stringify(bills));
                renderList();
                updateStats();
                updateMonth();
                updateStreak();
                renderChart();
                renderBadges();
                alert('导入成功！');
            }
        }catch(e){ alert('导入失败'); }
    };
    r.readAsText(file);
}

function exportBill(){
    if(bills.length==0) return alert('无数据');
    const blob = new Blob([JSON.stringify(bills,null,2)],{type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = '小七记账_'+new Date().toLocaleDateString()+'.json';
    a.click();
    URL.revokeObjectURL(a.href);
    alert('导出成功！');
}

function share(){
    if(bills.length==0) return alert('无数据');
    alert('已准备账单数据，可导出后分享');
    exportBill();
}
</script>
</body>
</html>