<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>小七记账 - </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
        }
        body {
            background-color: #f5f7fa;
            color: #333;
            padding-bottom: 100px;
        }
        @keyframes fireworks {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        .firework {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #ffd700;
            border-radius: 50%;
            animation: fireworks 0.8s ease-out forwards;
            z-index: 999;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 15px;
            width: 85%;
            max-width: 350px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            color: #333;
        }
        .modal-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #eee;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 16px;
        }
        .modal-btn-group {
            display: flex;
            gap: 10px;
        }
        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }
        .modal-btn.cancel {
            background: #f5f7fa;
            color: #666;
        }
        .modal-btn.confirm {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .summary-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .summary-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            width: 85%;
            max-width: 350px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        .summary-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            color: #667eea;
        }
        .summary-date {
            text-align: center;
            font-size: 14px;
            color: #999;
            margin-bottom: 20px;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 16px;
            border-bottom: 1px solid #f5f5f5;
        }
        .summary-label {
            color: #666;
            font-weight: 500;
        }
        .summary-income { color: #4cd964; font-weight: bold; }
        .summary-expense { color: #ff6b6b; font-weight: bold; }
        .summary-balance { font-weight: bold; color: #333; }
        .summary-tip {
            margin-top: 15px;
            padding: 12px;
            background: #f5f7fa;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.5;
            color: #666;
        }
        .summary-close {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 16px;
            font-weight: 500;
            margin-top: 20px;
            cursor: pointer;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 15px;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
        }
        .nickname-edit {
            position: absolute;
            top: 20px;
            right: 15px;
            font-size: 16px;
            cursor: pointer;
            opacity: 0.8;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .welcome-text {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        .header h1 {
            font-size: 22px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .stat-item {
            text-align: center;
            flex: 1;
            min-width: 80px;
        }
        .stat-item .label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        .stat-item .value {
            font-size: 18px;
            font-weight: bold;
        }
        .income { color: #4cd964; }
        .expense { color: #ff6b6b; }
        .balance { color: #fff; }
        .today-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        .streak-card {
            background: white;
            margin: 15px;
            padding: 20px 15px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .streak-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        .streak-day {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin: 5px 0;
        }
        .streak-desc {
            font-size: 12px;
            color: #999;
        }
        .month-card {
            background: white;
            margin: 15px;
            padding: 20px 15px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .month-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 12px;
            color: #333;
        }
        .month-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 15px;
            border-bottom: 1px solid #f5f5f5;
        }
        .month-row:last-child { border-bottom: none; }
        .quick-category {
            display: flex;
            gap: 10px;
            margin: 0 15px 15px;
            overflow-x: auto;
            padding-bottom: 8px;
        }
        .quick-btn {
            padding: 10px 16px;
            background: white;
            border: 1px solid #eee;
            border-radius: 20px;
            font-size: 14px;
            white-space: nowrap;
            cursor: pointer;
        }
        .quick-btn:hover, .quick-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }
        .date-search-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0 15px 15px;
            padding: 16px;
            border-radius: 16px;
            color: white;
            display: flex;
            align-items: center;
        }
        .search-left { margin-right: 16px; }
        .search-btn {
            width: 48px;
            height: 90px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 24px;
            color: white;
            cursor: pointer;
        }
        .search-right { flex: 1; }
        .search-date-input {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .search-date-input::-webkit-calendar-picker-indicator { filter: invert(1); }
        .search-result { font-size: 14px; line-height: 1.4; }
        .tip-container {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            margin: 15px;
            padding: 18px 15px;
            border-radius: 15px;
            color: white;
        }
        .tip-title { font-size: 16px; font-weight: 500; margin-bottom: 8px; }
        .tip-content { font-size: 14px; line-height: 1.5; opacity: 0.9; }
        .form-container {
            background: white;
            margin: 15px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .form-group { margin-bottom: 18px; }
        .form-group label {
            font-size: 14px;
            margin-bottom: 8px;
            display: block;
            color: #666;
        }
        .form-control {
            width: 100%;
            padding: 14px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }
        .type-selector { display: flex; gap: 10px; }
        .type-btn {
            flex: 1;
            padding: 14px;
            text-align: center;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
        }
        .type-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
        }
        .upload-container {
            border: 2px dashed #e0e0e0;
            border-radius: 10px;
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            background: #fafafa;
        }
        .upload-container:hover { border-color: #667eea; }
        .upload-icon { font-size: 32px; color: #667eea; margin-bottom: 10px; }
        .upload-text { font-size: 14px; color: #999; }
        .upload-hint { font-size: 12px; color: #ccc; }
        .preview-container {
            margin-top: 15px;
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            display: none;
        }
        .preview-image { width: 100%; border-radius: 10px; }
        .remove-image {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            cursor: pointer;
        }
        #imageInput { display: none; }
        .func-buttons { display: flex; margin: 0 15px 15px; gap: 10px; }
        .func-btn {
            flex: 1;
            padding: 12px;
            border: 1px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 10px;
            cursor: pointer;
        }
        .func-btn:hover { background: #667eea; color: white; }
        .list-container { margin: 0 15px; }
        .list-title { font-size: 16px; margin-bottom: 12px; font-weight: bold; }
        .bill-item {
            background: white;
            padding: 18px 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .bill-info { flex: 1; }
        .bill-remark { font-size: 15px; color: #333; margin-bottom: 4px; font-weight: 500; }
        .bill-date { font-size: 12px; color: #999; }
        .bill-amount { font-weight: bold; font-size: 16px; }
        .bill-actions { display:flex; gap:8px; margin-left: 10px; }
        .bill-action-btn {
            width:28px;
            height:28px;
            border:none;
            border-radius:50%;
            cursor:pointer;
            font-size:12px;
        }
        .edit-btn { background:#e3f2fd; color:#2196f3; }
        .delete-btn { background:#ffebee; color:#f44336; }
        .empty-tip { text-align: center; padding:30px; color:#999; }
        .bill-image-thumb {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            margin-right: 10px;
            cursor: pointer;
        }
        .image-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 99999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .image-viewer-img { max-width: 100%; max-height: 80vh; border-radius: 10px; }
        .close-image-viewer {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        .hidden { display: none !important; }
        #fileInput { display: none; }
    </style>
</head>
<body>

<div class="modal hidden" id="nicknameModal">
    <div class="modal-content">
        <div class="modal-title">修改昵称</div>
        <input type="text" class="modal-input" id="nicknameInput" placeholder="请输入昵称">
        <div class="modal-btn-group">
            <button class="modal-btn cancel" onclick="closeNicknameModal()">取消</button>
            <button class="modal-btn confirm" onclick="saveNickname()">保存</button>
        </div>
    </div>
</div>

<div class="summary-modal hidden" id="summaryModal">
    <div class="summary-content">
        <div class="summary-title">今日收支总结</div>
        <div class="summary-date" id="summaryDate"></div>
        <div class="summary-item">
            <span class="summary-label">今日收入</span>
            <span class="summary-income" id="summaryIncome">¥0.00</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">今日支出</span>
            <span class="summary-expense" id="summaryExpense">¥0.00</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">今日结余</span>
            <span class="summary-balance" id="summaryBalance">¥0.00</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">记账笔数</span>
            <span id="summaryCount">0</span>
        </div>
        <div class="summary-tip" id="summaryTip"></div>
        <button class="summary-close" onclick="closeSummaryModal()">知道了</button>
    </div>
</div>

<div class="image-viewer" id="imageViewer">
    <button class="close-image-viewer" onclick="closeImageViewer()">✕</button>
    <img src="" class="image-viewer-img" id="viewerImage">
</div>

<div class="header">
    <div class="nickname-edit" onclick="openNicknameModal()">✏️</div>
    <div class="welcome-text" id="welcomeText"></div>
    <h1 id="userNickname">小七记账</h1>
    <div class="stats">
        <div class="stat-item">
            <div class="label">总收入</div>
            <div class="value income" id="totalIncome">¥0.00</div>
        </div>
        <div class="stat-item">
            <div class="label">总支出</div>
            <div class="value expense" id="totalExpense">¥0.00</div>
        </div>
        <div class="stat-item">
            <div class="label">结余</div>
            <div class="value balance" id="totalBalance">¥0.00</div>
        </div>
    </div>
    <div class="today-stats">
        <div class="stat-item">
            <div class="label">今日收入</div>
            <div class="value income" id="todayIncome">¥0.00</div>
        </div>
        <div class="stat-item">
            <div class="label">今日支出</div>
            <div class="value expense" id="todayExpense">¥0.00</div>
        </div>
    </div>
</div>

<div class="streak-card">
    <div class="streak-title">📅 记账连续天数</div>
    <div class="streak-day" id="streakDay">0</div>
    <div class="streak-desc">坚持记账，越记越有钱～</div>
</div>

<div class="month-card">
    <div class="month-title">本月概况</div>
    <div class="month-row">
        <span>本月收入</span>
        <span class="income" id="monthIncome">¥0.00</span>
    </div>
    <div class="month-row">
        <span>本月支出</span>
        <span class="expense" id="monthExpense">¥0.00</span>
    </div>
    <div class="month-row">
        <span>本月结余</span>
        <span style="font-weight:bold" id="monthBalance">¥0.00</span>
    </div>
</div>

<div class="tip-container">
    <div class="tip-title">💡 今日小建议</div>
    <div class="tip-content" id="tipContent"></div>
</div>

<div class="date-search-card">
    <div class="search-left">
        <button class="search-btn" id="searchBtn">查询</button>
    </div>
    <div class="search-right">
        <input type="date" class="search-date-input" id="searchDate">
        <div class="search-result" id="searchResult"></div>
    </div>
</div>

<div class="quick-category" id="quickCategory">
    <div class="quick-btn" data-name="餐饮">🍽 餐饮</div>
    <div class="quick-btn" data-name="购物">🛍 购物</div>
    <div class="quick-btn" data-name="交通">🚗 交通</div>
    <div class="quick-btn" data-name="娱乐">🎮 娱乐</div>
    <div class="quick-btn" data-name="红包">🧧 红包</div>
    <div class="quick-btn" data-name="工资">💰 工资</div>
</div>

<div class="form-container">
    <div class="form-group">
        <label>交易类型</label>
        <div class="type-selector">
            <div class="type-btn active" data-type="expense">支出</div>
            <div class="type-btn" data-type="income">收入</div>
        </div>
    </div>
    <div class="form-group">
        <label>金额 (元)</label>
        <input type="number" class="form-control" id="amount" step="0.01" min="0.01" placeholder="请输入金额">
    </div>
    <div class="form-group">
        <label>备注</label>
        <input type="text" class="form-control" id="remark" placeholder="自动填充分类">
    </div>
    <div class="form-group">
        <label>日期</label>
        <input type="date" class="form-control" id="date">
    </div>
    <div class="form-group">
        <label>上传凭证图片</label>
        <div class="upload-container" onclick="document.getElementById('imageInput').click()">
            <div class="upload-icon">📷</div>
            <div class="upload-text">点击上传图片</div>
            <div class="upload-hint">支持JPG、PNG，自动压缩</div>
        </div>
        <input type="file" id="imageInput" accept="image/jpeg,image/png" onchange="previewImage(this)">
        <div class="preview-container" id="previewContainer">
            <img src="" class="preview-image" id="previewImage">
            <button class="remove-image" onclick="removeImage()">✕</button>
        </div>
    </div>
    <button class="btn" id="addBill">添加账单</button>
</div>

<div class="func-buttons">
    <button class="func-btn" id="importBtn">导入</button>
    <button class="func-btn" id="exportBtn">导出</button>
    <button class="func-btn" id="shareBtn">分享</button>
</div>
<input type="file" id="fileInput" accept=".json">

<div class="list-container">
    <div class="list-title">最近账单</div>
    <div id="billList"></div>
</div>

<script>
let bills = JSON.parse(localStorage.getItem('bills')) || [];
let editIndex = -1;
let userNickname = localStorage.getItem('userNickname') || '小七记账';
let summaryShown = JSON.parse(localStorage.getItem('summaryShown')) || {};
let currentImage = null;

const tips = [
    "早餐吃好，一天精神～",
    "少喝一杯奶茶，多存一笔钱",
    "记账让你更懂钱",
    "冲动消费先等24小时",
    "小钱不记，大钱不留",
    "合理规划消费，生活更从容～",
    "今日结余不错，继续保持！",
    "适当奖励自己，消费也要有幸福感～"
];

document.addEventListener('DOMContentLoaded', function(){
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;
    document.getElementById('searchDate').value = today;
    initNickname();
    initWelcome();
    initTip();
    bindAll();
    renderList();
    updateStats();
    updateMonth();
    updateStreak();
    searchByDate(today);
    checkSummaryModal();

    document.getElementById('billList').addEventListener('click', function(e) {
        if (e.target.classList.contains('bill-image-thumb')) {
            viewImage(e.target.dataset.src);
        }
    });
});

// 图片压缩
function compressImage(file, maxWidth = 800, quality = 0.5) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                if (width > maxWidth) {
                    height = height * maxWidth / width;
                    width = maxWidth;
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0,0,width,height);
                resolve(canvas.toDataURL(file.type === 'image/png' ? 'image/png' : 'image/jpeg', quality));
            };
        };
    });
}

// 预览图片
async function previewImage(input) {
    const file = input.files[0];
    if (!file) return;
    if (!file.type.match('image/jpeg|image/png')) {
        alert('仅支持JPG/PNG');
        input.value = '';
        return;
    }
    if (file.size > 5*1024*1024) {
        alert('图片不能超过5MB');
        input.value = '';
        return;
    }
    currentImage = await compressImage(file);
    document.getElementById('previewImage').src = currentImage;
    document.getElementById('previewContainer').style.display = 'block';
    input.value = '';
}

function removeImage() {
    currentImage = null;
    document.getElementById('previewContainer').style.display = 'none';
    document.getElementById('previewImage').src = '';
}

function viewImage(src) {
    document.getElementById('viewerImage').src = src;
    document.getElementById('imageViewer').style.display = 'flex';
}

function closeImageViewer() {
    document.getElementById('imageViewer').style.display = 'none';
}

// 昵称
function initNickname() {
    document.getElementById('userNickname').textContent = userNickname;
    document.getElementById('nicknameInput').value = userNickname;
}
function openNicknameModal() {
    document.getElementById('nicknameModal').classList.remove('hidden');
}
function closeNicknameModal() {
    document.getElementById('nicknameModal').classList.add('hidden');
}
function saveNickname() {
    const v = document.getElementById('nicknameInput').value.trim();
    if (!v) return alert('请输入昵称');
    userNickname = v;
    localStorage.setItem('userNickname', userNickname);
    document.getElementById('userNickname').textContent = userNickname;
    initWelcome();
    closeNicknameModal();
}

// 每日总结
function checkSummaryModal() {
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    if (summaryShown[today]) return;
    if (now.getHours() >= 21) {
        showSummaryModal(today);
        summaryShown[today] = true;
        localStorage.setItem('summaryShown', JSON.stringify(summaryShown));
    }
}
function showSummaryModal(date) {
    let inSum=0, outSum=0, count=0;
    bills.forEach(b=>{
        if(b.date===date){
            count++;
            b.type==='income' ? inSum+=b.amount : outSum+=b.amount;
        }
    });
    document.getElementById('summaryDate').textContent = date;
    document.getElementById('summaryIncome').textContent = '¥'+inSum.toFixed(2);
    document.getElementById('summaryExpense').textContent = '¥'+outSum.toFixed(2);
    document.getElementById('summaryBalance').textContent = '¥'+(inSum-outSum).toFixed(2);
    document.getElementById('summaryCount').textContent = count;
    document.getElementById('summaryModal').classList.remove('hidden');
}
function closeSummaryModal() {
    document.getElementById('summaryModal').classList.add('hidden');
}

function formatDate(d) {
    const t = new Date(d);
    return t.getFullYear()+'年'+(t.getMonth()+1)+'月'+t.getDate()+'日';
}
function fire() {
    for(let i=0;i<10;i++){
        const f=document.createElement('div');
        f.className='firework';
        f.style.left=Math.random()*100+'vw';
        f.style.top=Math.random()*100+'vh';
        document.body.appendChild(f);
        setTimeout(()=>f.remove(),800);
    }
}
function initWelcome() {
    const h = new Date().getHours();
    let t = `欢迎你，${userNickname}～`;
    if(h>=5&&h<10) t=`☀️ 早上好，${userNickname}！`;
    else if(h<14) t=`☀️ 上午好，${userNickname}！`;
    else if(h<18) t=`🌤 下午好，${userNickname}！`;
    else t=`🌙 晚上好，${userNickname}！`;
    document.getElementById('welcomeText').textContent = t;
}
function initTip() {
    document.getElementById('tipContent').textContent = tips[Math.floor(Math.random()*tips.length)];
}

function bindAll() {
    document.querySelectorAll('.type-btn').forEach(b=>{
        b.onclick=()=>{
            document.querySelectorAll('.type-btn').forEach(x=>x.classList.remove('active'));
            b.classList.add('active');
        }
    });
    document.querySelectorAll('.quick-btn').forEach(b=>{
        b.onclick=()=>{
            document.querySelectorAll('.quick-btn').forEach(x=>x.classList.remove('active'));
            b.classList.add('active');
            document.getElementById('remark').value = b.dataset.name;
        }
    });
    document.getElementById('addBill').onclick = saveBill;
    document.getElementById('importBtn').onclick = ()=>document.getElementById('fileInput').click();
    document.getElementById('fileInput').onchange = importBill;
    document.getElementById('exportBtn').onclick = exportBill;
    document.getElementById('shareBtn').onclick = share;
    document.getElementById('searchBtn').onclick = ()=>searchByDate(document.getElementById('searchDate').value);
}

// 保存账单（手机防卡死）
function saveBill() {
    const type = document.querySelector('.type-btn.active').dataset.type;
    const amount = parseFloat(document.getElementById('amount').value);
    const remark = document.getElementById('remark').value.trim() || '未分类';
    const date = document.getElementById('date').value;

    if(!amount || amount<=0) return alert('请输入有效金额');
    if(!date) return alert('请选择日期');

    const bill = { id:Date.now(), type, amount, remark, date, image:currentImage };
    const old = [...bills];

    if(editIndex===-1) bills.unshift(bill);
    else { bills[editIndex] = bill; editIndex=-1; document.getElementById('addBill').textContent='添加账单'; }

    try {
        localStorage.setItem('bills', JSON.stringify(bills));
    } catch(e) {
        bills = old;
        return alert('保存失败：数据太多，请删除旧账单');
    }

    resetForm();
    renderList();
    updateStats();
    updateMonth();
    updateStreak();
    searchByDate(date);
    fire();
    alert('保存成功！');
}

function resetForm() {
    document.getElementById('amount').value='';
    document.getElementById('remark').value='';
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
    document.querySelectorAll('.type-btn').forEach(b=>b.classList.remove('active'));
    document.querySelector('[data-type="expense"]').classList.add('active');
    document.querySelectorAll('.quick-btn').forEach(b=>b.classList.remove('active'));
    removeImage();
}

function renderList(filter) {
    const arr = filter || bills;
    const el = document.getElementById('billList');
    if(arr.length===0) return el.innerHTML='<div class="empty-tip">暂无账单</div>';
    let html='';
    arr.forEach((b,i)=>{
        const idx = filter ? bills.findIndex(x=>x.id===b.id) : i;
        const img = b.image ? `<img src="${b.image}" data-src="${b.image}" class="bill-image-thumb">` : '';
        html+=`
        <div class="bill-item">
            ${img}
            <div class="bill-info">
                <div class="bill-remark">${b.remark}</div>
                <div class="bill-date">${formatDate(b.date)}</div>
            </div>
            <div class="bill-amount ${b.type=='income'?'income':'expense'}">
                ${b.type=='income'?'+':'-'}¥${b.amount.toFixed(2)}
            </div>
            <div class="bill-actions">
                <button class="bill-action-btn edit-btn" onclick="editBill(${idx})">✏️</button>
                <button class="bill-action-btn delete-btn" onclick="deleteBill(${idx})">🗑️</button>
            </div>
        </div>`;
    });
    el.innerHTML = html;
}

function editBill(idx) {
    const b = bills[idx];
    editIndex = idx;
    document.querySelectorAll('.type-btn').forEach(x=>x.classList.remove('active'));
    document.querySelector(`[data-type="${b.type}"]`).classList.add('active');
    document.getElementById('amount').value = b.amount;
    document.getElementById('remark').value = b.remark;
    document.getElementById('date').value = b.date;
    if(b.image){
        currentImage = b.image;
        document.getElementById('previewImage').src = b.image;
        document.getElementById('previewContainer').style.display='block';
    } else removeImage();
    document.getElementById('addBill').textContent='保存修改';
}

function deleteBill(idx) {
    if(!confirm('确定删除？')) return;
    bills.splice(idx,1);
    localStorage.setItem('bills',JSON.stringify(bills));
    renderList();
    updateStats();
    updateMonth();
    updateStreak();
    searchByDate(document.getElementById('searchDate').value);
}

function updateStats() {
    let inAll=0, outAll=0, inToday=0, outToday=0;
    const today = new Date().toISOString().split('T')[0];
    bills.forEach(b=>{
        b.type==='income' ? inAll+=b.amount : outAll+=b.amount;
        if(b.date===today) b.type==='income' ? inToday+=b.amount : outToday+=b.amount;
    });
    document.getElementById('totalIncome').textContent='¥'+inAll.toFixed(2);
    document.getElementById('totalExpense').textContent='¥'+outAll.toFixed(2);
    document.getElementById('totalBalance').textContent='¥'+(inAll-outAll).toFixed(2);
    document.getElementById('todayIncome').textContent='¥'+inToday.toFixed(2);
    document.getElementById('todayExpense').textContent='¥'+outToday.toFixed(2);
}

function updateMonth() {
    const now = new Date();
    const y = now.getFullYear(), m = now.getMonth()+1;
    let inM=0, outM=0;
    bills.forEach(b=>{
        const d = new Date(b.date);
        if(d.getFullYear()===y && d.getMonth()+1===m){
            b.type==='income' ? inM+=b.amount : outM+=b.amount;
        }
    });
    document.getElementById('monthIncome').textContent='¥'+inM.toFixed(2);
    document.getElementById('monthExpense').textContent='¥'+outM.toFixed(2);
    document.getElementById('monthBalance').textContent='¥'+(inM-outM).toFixed(2);
}

function updateStreak() {
    const s = new Set(bills.map(b=>b.date));
    const arr = Array.from(s).map(d=>new Date(d)).sort((a,b)=>b-a);
    if(!arr.length) return document.getElementById('streakDay').textContent='0';
    const today = new Date(); today.setHours(0,0,0,0);
    const last = arr[0]; last.setHours(0,0,0,0);
    const diff =Math.floor((today-last)/86400000);
    let streak=0;
    if(diff<=1){
        streak=1;
        for(let i=1;i<arr.length;i++){
            const a = arr[i]; a.setHours(0,0,0,0);
            const b = arr[i-1]; b.setHours(0,0,0,0);
            const prev = new Date(b); prev.setDate(b.getDate()-1);
            if(a.getTime()===prev.getTime()) streak++;
            else break;
        }
    }
    document.getElementById('streakDay').textContent=streak;
}

function searchByDate(d) {
    if(!d) return;
    let inSum=0, outSum=0;
    const list = bills.filter(b=>b.date===d);
    list.forEach(b=>b.type==='income'?inSum+=b.amount:outSum+=b.amount);
    document.getElementById('searchResult').textContent = 
        `${formatDate(d)} 收入¥${inSum.toFixed(2)} 支出¥${outSum.toFixed(2)} 结余¥${(inSum-outSum).toFixed(2)}`;
    renderList(list);
}

function importBill(e) {
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = ev=>{
        try{
            const data = JSON.parse(ev.target.result);
            if(Array.isArray(data)){
                bills = data;
                localStorage.setItem('bills',JSON.stringify(bills));
                renderList();
                updateStats();
                updateMonth();
                updateStreak();
                alert('导入成功！');
            }
        }catch{ alert('导入失败'); }
    };
    r.readAsText(f);
}

function exportBill() {
    const blob = new Blob([JSON.stringify(bills)],{type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = '账单_'+new Date().toISOString().split('T')[0]+'.json';
    a.click();
}

function share() {
    const t = "我的小七记账账单";
    const url = window.location.href;
    if(navigator.share) navigator.share({title:t,text:url});
    else alert('分享功能需要浏览器支持');
}
</script>
</body>
</html>