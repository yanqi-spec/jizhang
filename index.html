<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>小七记账 - 手机端</title>
    <style>
        /* 全局重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            padding-bottom: 80px;
        }

        /* 头部样式 */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 15px;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 10px;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stat-item {
            text-align: center;
            flex: 1;
            min-width: 80px;
        }

        .stat-item .label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .stat-item .value {
            font-size: 18px;
            font-weight: bold;
        }

        .income {
            color: #4cd964;
        }

        .expense {
            color: #ff6b6b;
        }

        .balance {
            color: #fff;
        }

        /* 今日收支统计 */
        .today-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        /* 表单区域 */
        .form-container {
            background: white;
            margin: 15px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            margin-bottom: 8px;
            color: #666;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            border-color: #667eea;
        }

        .type-selector {
            display: flex;
            gap: 10px;
        }

        .type-btn {
            flex: 1;
            padding: 12px;
            text-align: center;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .type-btn.active {
            background-color: #667eea;
            color: white;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }

        /* 功能按钮区 */
        .func-buttons {
            display: flex;
            margin: 0 15px 15px;
            gap: 10px;
        }

        .func-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
        }

        /* 日期查询区域 */
        .date-search {
            background: white;
            margin: 0 15px 15px;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-search input {
            flex: 1;
            padding: 10px;
        }

        .date-search button {
            padding: 10px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        .search-result {
            text-align: center;
            padding: 10px;
            font-size: 15px;
            color: #666;
        }

        /* 账单列表 */
        .list-container {
            margin: 0 15px;
        }

        .list-title {
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
            font-weight: bold;
        }

        .bill-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bill-left {
            flex: 1;
        }

        .bill-type {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 5px;
        }

        .type-income {
            background: #e8f5e9;
            color: #4cd964;
        }

        .type-expense {
            background: #ffebee;
            color: #ff6b6b;
        }

        .bill-remark {
            font-size: 15px;
            color: #333;
            margin-bottom: 3px;
        }

        .bill-date {
            font-size: 12px;
            color: #999;
        }

        .bill-amount {
            font-size: 18px;
            font-weight: bold;
        }

        .bill-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .edit-btn {
            background: #e3f2fd;
            color: #2196f3;
        }

        .delete-btn {
            background: #ffebee;
            color: #f44336;
        }

        /* 隐藏的导入文件输入 */
        #fileInput {
            display: none;
        }

        /* 空数据提示 */
        .empty-tip {
            text-align: center;
            padding: 30px;
            color: #999;
            font-size: 14px;
        }

        /* 响应式适配 */
        @media (max-width: 375px) {
            .header h1 {
                font-size: 20px;
            }
            .stat-item .value {
                font-size: 16px;
            }
            .bill-amount {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- 头部统计区 -->
    <div class="header">
        <h1>小七记账</h1>
        <div class="stats">
            <div class="stat-item">
                <div class="label">总收入</div>
                <div class="value income" id="totalIncome">¥0.00</div>
            </div>
            <div class="stat-item">
                <div class="label">总支出</div>
                <div class="value expense" id="totalExpense">¥0.00</div>
            </div>
            <div class="stat-item">
                <div class="label">结余</div>
                <div class="value balance" id="totalBalance">¥0.00</div>
            </div>
        </div>
        <!-- 新增今日收支统计 -->
        <div class="today-stats">
            <div class="stat-item">
                <div class="label">今日收入</div>
                <div class="value income" id="todayIncome">¥0.00</div>
            </div>
            <div class="stat-item">
                <div class="label">今日支出</div>
                <div class="value expense" id="todayExpense">¥0.00</div>
            </div>
        </div>
    </div>

    <!-- 日期查询区域 -->
    <div class="date-search">
        <input type="date" class="form-control" id="searchDate" placeholder="选择查询日期">
        <button id="searchBtn">查询</button>
        <div id="searchResult" class="search-result"></div>
    </div>

    <!-- 记账表单 -->
    <div class="form-container">
        <div class="form-group">
            <label>交易类型</label>
            <div class="type-selector">
                <div class="type-btn active" data-type="expense">支出</div>
                <div class="type-btn" data-type="income">收入</div>
            </div>
        </div>
        <div class="form-group">
            <label>金额 (元)</label>
            <input type="number" class="form-control" id="amount" placeholder="请输入金额" step="0.01" min="0.01">
        </div>
        <div class="form-group">
            <label>备注</label>
            <input type="text" class="form-control" id="remark" placeholder="例如：早餐、工资">
        </div>
        <div class="form-group">
            <label>日期</label>
            <input type="date" class="form-control" id="date">
        </div>
        <button class="btn btn-primary" id="addBill">添加账单</button>
    </div>

    <!-- 功能按钮区（新增分享按钮） -->
    <div class="func-buttons">
        <button class="func-btn" id="importBtn">导入账单</button>
        <button class="func-btn" id="exportBtn">导出账单</button>
        <button class="func-btn" id="shareBtn">分享账单</button>
    </div>
    <input type="file" id="fileInput" accept=".json">

    <!-- 账单列表 -->
    <div class="list-container">
        <div class="list-title">最近账单</div>
        <div id="billList">
            <div class="empty-tip">暂无账单，添加你的第一笔记账吧！</div>
        </div>
    </div>

    <script>
        // 全局变量
        let bills = JSON.parse(localStorage.getItem('bills')) || [];
        let editIndex = -1; // 编辑状态的索引，-1表示新增

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 设置默认日期为今天
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            document.getElementById('searchDate').value = today;

            // 绑定事件
            bindEvents();
            // 渲染账单列表
            renderBillList();
            // 更新统计数据（包含今日收支）
            updateStats();
            // 初始化当日查询结果
            searchByDate(today);
        });

        // 事件绑定
        function bindEvents() {
            // 交易类型选择
            const typeBtns = document.querySelectorAll('.type-btn');
            typeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    typeBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // 添加/编辑账单
            document.getElementById('addBill').addEventListener('click', saveBill);

            // 导入账单
            document.getElementById('importBtn').addEventListener('click', function() {
                document.getElementById('fileInput').click();
            });
            document.getElementById('fileInput').addEventListener('change', importBills);

            // 导出账单
            document.getElementById('exportBtn').addEventListener('click', exportBills);

            // 新增：分享账单
            document.getElementById('shareBtn').addEventListener('click', shareBills);

            // 新增：日期查询
            document.getElementById('searchBtn').addEventListener('click', function() {
                const searchDate = document.getElementById('searchDate').value;
                if (!searchDate) {
                    alert('请选择要查询的日期！');
                    return;
                }
                searchByDate(searchDate);
            });
        }

        // 保存账单（新增/编辑）
        function saveBill() {
            // 获取表单数据
            const type = document.querySelector('.type-btn.active').dataset.type;
            const amount = parseFloat(document.getElementById('amount').value);
            const remark = document.getElementById('remark').value.trim() || (type === 'income' ? '收入' : '支出');
            const date = document.getElementById('date').value;

            // 验证
            if (!amount || amount <= 0) {
                alert('请输入有效的金额！');
                return;
            }
            if (!date) {
                alert('请选择日期！');
                return;
            }

            const bill = {
                id: Date.now(), // 用时间戳作为唯一ID
                type,
                amount,
                remark,
                date
            };

            if (editIndex === -1) {
                // 新增
                bills.unshift(bill); // 新增的放在最前面
            } else {
                // 编辑
                bills[editIndex] = bill;
                editIndex = -1;
                document.getElementById('addBill').textContent = '添加账单';
            }

            // 保存到本地存储
            localStorage.setItem('bills', JSON.stringify(bills));

            // 重置表单
            resetForm();

            // 重新渲染
            renderBillList();
            updateStats();
            // 更新当日查询结果
            const today = new Date().toISOString().split('T')[0];
            if (document.getElementById('searchDate').value === today) {
                searchByDate(today);
            }

            alert(editIndex === -1 ? '账单添加成功！' : '账单编辑成功！');
        }

        // 重置表单
        function resetForm() {
            document.getElementById('amount').value = '';
            document.getElementById('remark').value = '';
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            // 重置类型为支出
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-type="expense"]').classList.add('active');
        }

        // 渲染账单列表
        function renderBillList(filteredBills = null) {
            const billList = document.getElementById('billList');
            const displayBills = filteredBills || bills;
            
            if (displayBills.length === 0) {
                billList.innerHTML = '<div class="empty-tip">暂无账单数据！</div>';
                return;
            }

            let html = '';
            displayBills.forEach((bill, index) => {
                // 如果是筛选后的列表，需要找到原数组索引
                const originalIndex = filteredBills ? bills.findIndex(b => b.id === bill.id) : index;
                
                html += `
                    <div class="bill-item">
                        <div class="bill-left">
                            <div class="bill-type ${bill.type === 'income' ? 'type-income' : 'type-expense'}">
                                ${bill.type === 'income' ? '收入' : '支出'}
                            </div>
                            <div class="bill-remark">${bill.remark}</div>
                            <div class="bill-date">${formatDate(bill.date)}</div>
                        </div>
                        <div class="bill-amount ${bill.type === 'income' ? 'income' : 'expense'}">
                            ¥${bill.amount.toFixed(2)}
                        </div>
                        <div class="bill-actions">
                            <button class="action-btn edit-btn" onclick="editBill(${originalIndex})">✏</button>
                            <button class="action-btn delete-btn" onclick="deleteBill(${originalIndex})">🗑</button>
                        </div>
                    </div>
                `;
            });

            billList.innerHTML = html;
        }

        // 编辑账单
        function editBill(index) {
            const bill = bills[index];
            editIndex = index;

            // 填充表单
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-type="${bill.type}"]`).classList.add('active');
            document.getElementById('amount').value = bill.amount;
            document.getElementById('remark').value = bill.remark;
            document.getElementById('date').value = bill.date;

            // 修改按钮文字
            document.getElementById('addBill').textContent = '保存修改';

            // 滚动到表单顶部
            window.scrollTo(0, 0);
        }

        // 删除账单
        function deleteBill(index) {
            if (confirm('确定要删除这条账单吗？')) {
                bills.splice(index, 1);
                localStorage.setItem('bills', JSON.stringify(bills));
                renderBillList();
                updateStats();
                // 更新日期查询结果
                const searchDate = document.getElementById('searchDate').value;
                if (searchDate) {
                    searchByDate(searchDate);
                }
                alert('账单删除成功！');
            }
        }

        // 更新统计数据（新增今日收支）
        function updateStats() {
            let totalIncome = 0;
            let totalExpense = 0;
            let todayIncome = 0;
            let todayExpense = 0;

            const today = new Date().toISOString().split('T')[0];

            bills.forEach(bill => {
                // 总收支统计
                if (bill.type === 'income') {
                    totalIncome += bill.amount;
                } else {
                    totalExpense += bill.amount;
                }

                // 今日收支统计
                if (bill.date === today) {
                    if (bill.type === 'income') {
                        todayIncome += bill.amount;
                    } else {
                        todayExpense += bill.amount;
                    }
                }
            });

            const balance = totalIncome - totalExpense;

            // 更新页面显示
            document.getElementById('totalIncome').textContent = `¥${totalIncome.toFixed(2)}`;
            document.getElementById('totalExpense').textContent = `¥${totalExpense.toFixed(2)}`;
            document.getElementById('totalBalance').textContent = `¥${balance.toFixed(2)}`;
            // 新增今日收支显示
            document.getElementById('todayIncome').textContent = `¥${todayIncome.toFixed(2)}`;
            document.getElementById('todayExpense').textContent = `¥${todayExpense.toFixed(2)}`;
        }

        // 导入账单
        function importBills(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 验证文件类型
            if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                alert('请选择JSON格式的账单文件！');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedBills = JSON.parse(e.target.result);
                    // 验证导入的数据格式
                    if (!Array.isArray(importedBills) || importedBills.some(b => !b.type || !b.amount || !b.date)) {
                        alert('账单文件格式不正确！');
                        return;
                    }

                    // 合并账单（去重，根据ID）
                    const existingIds = bills.map(b => b.id);
                    const newBills = importedBills.filter(b => !existingIds.includes(b.id));
                    bills = [...bills, ...newBills];

                    // 保存并更新
                    localStorage.setItem('bills', JSON.stringify(bills));
                    renderBillList();
                    updateStats();
                    // 更新日期查询结果
                    const searchDate = document.getElementById('searchDate').value;
                    if (searchDate) {
                        searchByDate(searchDate);
                    }

                    alert(`成功导入 ${newBills.length} 条账单！`);
                    // 清空文件选择
                    document.getElementById('fileInput').value = '';
                } catch (error) {
                    alert('导入失败：' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // 导出账单
        function exportBills() {
            if (bills.length === 0) {
                alert('暂无账单可导出！');
                return;
            }

            // 转为JSON字符串
            const jsonStr = JSON.stringify(bills, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });

            // 创建下载链接
            const a = document.createElement('a');
            const fileName = `记账数据_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
            a.href = URL.createObjectURL(blob);
            a.download = fileName;
            a.click();

            // 释放URL
            URL.revokeObjectURL(a.href);
            alert('账单导出成功！');
        }

        // 新增：分享账单功能
        function shareBills() {
            if (bills.length === 0) {
                alert('暂无账单可分享！');
                return;
            }

            // 弹出同步确认框
            const isSync = confirm('分享账单时是否同步当前所有账单数据？\n\n确认后将生成账单文件并唤起分享功能');
            
            if (isSync) {
                // 生成分享用的JSON文件
                const jsonStr = JSON.stringify(bills, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const fileUrl = URL.createObjectURL(blob);

                // 兼容Web Share API（移动端主流浏览器支持）
                if (navigator.share) {
                    // 准备分享内容
                    const shareData = {
                        title: '小七记账 - 账单数据',
                        text: `小七记账账单数据（共${bills.length}条），导出时间：${new Date().toLocaleString()}`,
                        files: [new File([blob], `小七记账_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`, { type: 'application/json' })]
                    };

                    // 调用系统分享功能
                    navigator.share(shareData)
                        .then(() => alert('分享发起成功！'))
                        .catch((error) => {
                            alert(`分享取消或失败：${error.message}`);
                            // 备用方案：直接下载文件
                            const a = document.createElement('a');
                            a.href = fileUrl;
                            a.download = `小七记账_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
                            a.click();
                        });
                } else {
                    // 不支持Web Share API时，直接下载文件并提示
                    alert('你的浏览器不支持分享功能，已为你生成账单文件，请手动分享！');
                    const a = document.createElement('a');
                    a.href = fileUrl;
                    a.download = `小七记账_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
                    a.click();
                }

                // 释放URL
                setTimeout(() => URL.revokeObjectURL(fileUrl), 1000);
            }
        }

        // 新增：按日期查询收支
        function searchByDate(searchDate) {
            let dayIncome = 0;
            let dayExpense = 0;
            const filteredBills = [];

            // 筛选指定日期的账单并统计
            bills.forEach(bill => {
                if (bill.date === searchDate) {
                    filteredBills.push(bill);
                    if (bill.type === 'income') {
                        dayIncome += bill.amount;
                    } else {
                        dayExpense += bill.amount;
                    }
                }
            });

            // 更新查询结果显示
            const resultText = `${formatDate(searchDate)}：收入 ¥${dayIncome.toFixed(2)}，支出 ¥${dayExpense.toFixed(2)}，结余 ¥${(dayIncome - dayExpense).toFixed(2)}`;
            document.getElementById('searchResult').textContent = resultText;

            // 渲染筛选后的账单列表
            renderBillList(filteredBills);
        }

        // 格式化日期（YYYY-MM-DD → 年-月-日）
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
        }
    </script>
</body>
</html>