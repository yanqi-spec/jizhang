<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>小七记账 - 手机端</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            padding-bottom: 100px;
        }

        /* 礼花动画 */
        @keyframes fireworks {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        .firework {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #ffd700;
            border-radius: 50%;
            animation: fireworks 0.8s ease-out forwards;
            z-index: 999;
        }

        /* 昵称编辑弹窗 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 15px;
            width: 85%;
            max-width: 350px;
        }
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }
        .modal-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 16px;
        }
        .modal-btn-group {
            display: flex;
            gap: 10px;
        }
        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
        }
        .modal-btn.cancel {
            background: #eee;
            color: #666;
        }
        .modal-btn.confirm {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* 每日总结弹窗 */
        .summary-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .summary-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            width: 85%;
            max-width: 350px;
        }
        .summary-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            color: #667eea;
        }
        .summary-date {
            text-align: center;
            font-size: 14px;
            color: #999;
            margin-bottom: 20px;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 16px;
            border-bottom: 1px solid #f5f5f5;
        }
        .summary-label {
            color: #666;
        }
        .summary-income {
            color: #4cd964;
            font-weight: bold;
        }
        .summary-expense {
            color: #ff6b6b;
            font-weight: bold;
        }
        .summary-balance {
            font-weight: bold;
        }
        .summary-tip {
            margin-top: 15px;
            padding: 10px;
            background: #f5f7fa;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.5;
        }
        .summary-close {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: #667eea;
            color: white;
            font-size: 16px;
            margin-top: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 15px;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        .nickname-edit {
            position: absolute;
            top: 20px;
            right: 15px;
            font-size: 16px;
            cursor: pointer;
            opacity: 0.8;
        }
        .welcome-text {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        .header h1 {
            font-size: 22px;
            margin-bottom: 10px;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .stat-item {
            text-align: center;
            flex: 1;
            min-width: 80px;
        }
        .stat-item .label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        .stat-item .value {
            font-size: 18px;
            font-weight: bold;
        }
        .income { color: #4cd964; }
        .expense { color: #ff6b6b; }
        .balance { color: #fff; }

        .today-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        /* 连续打卡 */
        .streak-card {
            background: white;
            margin: 15px;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .streak-title {
            font-size: 14px;
            color: #666;
        }
        .streak-day {
            font-size: 30px;
            font-weight: bold;
            color: #667eea;
            margin: 5px 0;
        }

        /* 月度总结 */
        .month-card {
            background: white;
            margin: 15px;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .month-title {
            font-weight: bold;
            margin-bottom: 8px;
        }
        .month-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 14px;
        }

        /* 快捷分类 */
        .quick-category {
            display: flex;
            gap: 8px;
            margin: 0 15px 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        .quick-btn {
            padding: 8px 12px;
            background: white;
            border: 1px solid #eee;
            border-radius: 20px;
            font-size: 13px;
            white-space: nowrap;
        }
        .quick-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .tip-container {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            margin: 15px;
            padding: 15px;
            border-radius: 15px;
            color: white;
        }

        .form-container {
            background: white;
            margin: 15px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .form-group { margin-bottom: 15px; }
        .form-group label {
            font-size: 14px;
            margin-bottom: 8px;
            display: block;
            color: #666;
        }
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }
        .type-selector {
            display: flex;
            gap: 10px;
        }
        .type-btn {
            flex: 1;
            padding: 12px;
            text-align: center;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
        }
        .type-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .func-buttons {
            display: flex;
            margin: 0 15px 15px;
            gap: 10px;
        }
        .func-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 10px;
        }

        .date-search {
            background: white;
            margin: 0 15px 15px;
            padding: 15px;
            border-radius: 15px;
            display: flex;
            gap: 10px;
        }
        .date-search input { flex:1; padding:10px; }
        .date-search button {
            padding: 10px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
        }

        .list-container { margin: 0 15px; }
        .list-title {
            font-size: 16px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .bill-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        .bill-item:hover { transform: translateY(-3px); }
        .empty-tip { text-align: center; padding:30px; color:#999; }

        /* 隐藏元素 */
        .hidden { display: none !important; }
    </style>
</head>
<body>
<!-- 昵称编辑弹窗 -->
<div class="modal hidden" id="nicknameModal">
    <div class="modal-content">
        <div class="modal-title">修改我的昵称</div>
        <input type="text" class="modal-input" id="nicknameInput" placeholder="请输入昵称">
        <div class="modal-btn-group">
            <button class="modal-btn cancel" onclick="closeNicknameModal()">取消</button>
            <button class="modal-btn confirm" onclick="saveNickname()">保存</button>
        </div>
    </div>
</div>

<!-- 每日总结弹窗 -->
<div class="summary-modal hidden" id="summaryModal">
    <div class="summary-content">
        <div class="summary-title">今日收支总结</div>
        <div class="summary-date" id="summaryDate"></div>
        <div class="summary-item">
            <span class="summary-label">今日收入</span>
            <span class="summary-income" id="summaryIncome">¥0.00</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">今日支出</span>
            <span class="summary-expense" id="summaryExpense">¥0.00</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">今日结余</span>
            <span class="summary-balance" id="summaryBalance">¥0.00</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">今日记账笔数</span>
            <span id="summaryCount">0</span>
        </div>
        <div class="summary-tip" id="summaryTip"></div>
        <button class="summary-close" onclick="closeSummaryModal()">知道了</button>
    </div>
</div>

<div class="header">
    <div class="nickname-edit" onclick="openNicknameModal()">✏️</div>
    <div class="welcome-text" id="welcomeText"></div>
    <h1 id="userNickname">小七记账</h1>
    <div class="stats">
        <div class="stat-item">
            <div class="label">总收入</div>
            <div class="value income" id="totalIncome">¥0.00</div>
        </div>
        <div class="stat-item">
            <div class="label">总支出</div>
            <div class="value expense" id="totalExpense">¥0.00</div>
        </div>
        <div class="stat-item">
            <div class="label">结余</div>
            <div class="value balance" id="totalBalance">¥0.00</div>
        </div>
    </div>
    <div class="today-stats">
        <div class="stat-item">
            <div class="label">今日收入</div>
            <div class="value income" id="todayIncome">¥0.00</div>
        </div>
        <div class="stat-item">
            <div class="label">今日支出</div>
            <div class="value expense" id="todayExpense">¥0.00</div>
        </div>
    </div>
</div>

<!-- 连续打卡 -->
<div class="streak-card">
    <div class="streak-title">📅 记账连续天数</div>
    <div class="streak-day" id="streakDay">0</div>
    <div style="font-size:12px;color:#999">坚持记账，越记越有钱～</div>
</div>

<!-- 月度总结 -->
<div class="month-card">
    <div class="month-title">本月概况</div>
    <div class="month-row">
        <span>本月收入</span>
        <span class="income" id="monthIncome">¥0.00</span>
    </div>
    <div class="month-row">
        <span>本月支出</span>
        <span class="expense" id="monthExpense">¥0.00</span>
    </div>
    <div class="month-row">
        <span>本月结余</span>
        <span style="font-weight:bold" id="monthBalance">¥0.00</span>
    </div>
</div>

<div class="tip-container">
    <div class="tip-title">💡 今日小建议</div>
    <div class="tip-content" id="tipContent"></div>
</div>

<div class="date-search">
    <input type="date" class="form-control" id="searchDate">
    <button id="searchBtn">查询</button>
    <div id="searchResult" style="text-align:center;color:#666"></div>
</div>

<!-- 快捷分类 -->
<div class="quick-category" id="quickCategory">
    <div class="quick-btn" data-name="餐饮">🍽 餐饮</div>
    <div class="quick-btn" data-name="购物">🛍 购物</div>
    <div class="quick-btn" data-name="交通">🚗 交通</div>
    <div class="quick-btn" data-name="娱乐">🎮 娱乐</div>
    <div class="quick-btn" data-name="红包">🧧 红包</div>
    <div class="quick-btn" data-name="工资">💰 工资</div>
</div>

<div class="form-container">
    <div class="form-group">
        <label>交易类型</label>
        <div class="type-selector">
            <div class="type-btn active" data-type="expense">支出</div>
            <div class="type-btn" data-type="income">收入</div>
        </div>
    </div>

    <div class="form-group">
        <label>金额 (元)</label>
        <input type="number" class="form-control" id="amount" step="0.01" min="0.01" placeholder="请输入金额">
    </div>
    <div class="form-group">
        <label>备注</label>
        <input type="text" class="form-control" id="remark" placeholder="自动填充分类">
    </div>
    <div class="form-group">
        <label>日期</label>
        <input type="date" class="form-control" id="date">
    </div>
    <button class="btn" id="addBill">添加账单</button>
</div>

<div class="func-buttons">
    <button class="func-btn" id="importBtn">导入</button>
    <button class="func-btn" id="exportBtn">导出</button>
    <button class="func-btn" id="shareBtn">分享</button>
</div>
<input type="file" id="fileInput" accept=".json" style="display:none">

<div class="list-container">
    <div class="list-title">最近账单</div>
    <div id="billList"></div>
</div>

<script>
let bills = JSON.parse(localStorage.getItem('bills')) || [];
let editIndex = -1;
let userNickname = localStorage.getItem('userNickname') || '小七记账';
// 记录每日总结是否已弹窗（按日期存储）
let summaryShown = JSON.parse(localStorage.getItem('summaryShown')) || {};

const tips = [
    "早餐吃好，一天精神～",
    "少喝一杯奶茶，多存一笔钱",
    "记账让你更懂钱",
    "冲动消费先等24小时",
    "小钱不记，大钱不留",
    "合理规划消费，生活更从容～",
    "今日结余不错，继续保持！",
    "适当奖励自己，消费也要有幸福感～"
];

document.addEventListener('DOMContentLoaded', function(){
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;
    document.getElementById('searchDate').value = today;
    
    // 初始化昵称
    initNickname();
    // 初始化欢迎语
    initWelcome();
    // 初始化小贴士
    initTip();
    // 绑定事件
    bindAll();
    // 渲染账单列表
    renderList();
    // 更新统计数据
    updateStats();
    // 更新月度数据
    updateMonth();
    // 更新连续打卡天数
    updateStreak();
    // 初始化当日查询
    searchByDate(today);
    // 检查并显示每日总结弹窗
    checkSummaryModal();
    // 定时检查21点弹窗
    setInterval(checkSummaryModal, 60000); // 每分钟检查一次
});

// ===================== 昵称相关功能 =====================
function initNickname() {
    document.getElementById('userNickname').textContent = userNickname;
    document.getElementById('nicknameInput').value = userNickname;
}

function openNicknameModal() {
    document.getElementById('nicknameModal').classList.remove('hidden');
}

function closeNicknameModal() {
    document.getElementById('nicknameModal').classList.add('hidden');
}

function saveNickname() {
    const newNickname = document.getElementById('nicknameInput').value.trim();
    if (!newNickname) {
        alert('请输入有效的昵称！');
        return;
    }
    userNickname = newNickname;
    localStorage.setItem('userNickname', userNickname);
    document.getElementById('userNickname').textContent = userNickname;
    initWelcome(); // 重新初始化欢迎语
    closeNicknameModal();
    alert('昵称修改成功！');
}

// ===================== 每日总结弹窗 =====================
function checkSummaryModal() {
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    const hour = now.getHours();
    
    // 已弹窗过则不再显示
    if (summaryShown[today]) return;
    
    // 21点及以后，或次日打开时（如果前一天21点后未打开）
    if (hour >= 21 || (summaryShown[today] === undefined && now.getDate() > new Date(today).getDate())) {
        showSummaryModal(today);
        summaryShown[today] = true;
        localStorage.setItem('summaryShown', JSON.stringify(summaryShown));
    }
}

function showSummaryModal(date) {
    // 统计当日数据
    let dayIncome = 0;
    let dayExpense = 0;
    let billCount = 0;
    
    bills.forEach(bill => {
        if (bill.date === date) {
            billCount++;
            if (bill.type === 'income') {
                dayIncome += bill.amount;
            } else {
                dayExpense += bill.amount;
            }
        }
    });
    
    const balance = dayIncome - dayExpense;
    
    // 更新弹窗内容
    document.getElementById('summaryDate').textContent = formatDate(date);
    document.getElementById('summaryIncome').textContent = `¥${dayIncome.toFixed(2)}`;
    document.getElementById('summaryExpense').textContent = `¥${dayExpense.toFixed(2)}`;
    document.getElementById('summaryBalance').textContent = `¥${balance.toFixed(2)}`;
    document.getElementById('summaryCount').textContent = billCount;
    
    // 生成个性化提示
    let tip = '';
    if (billCount === 0) {
        tip = '今日还没有记账哦～记得记录每一笔收支，才能更好地规划财务！';
    } else if (balance > 0) {
        tip = `太棒了！今日结余¥${balance.toFixed(2)}，继续保持理性消费的好习惯～`;
    } else if (balance === 0) {
        tip = '今日收支平衡，消费规划很到位！';
    } else {
        tip = `今日支出超出收入¥${Math.abs(balance).toFixed(2)}，明天可以适当控制一下哦～`;
    }
    document.getElementById('summaryTip').textContent = tip;
    
    // 显示弹窗
    document.getElementById('summaryModal').classList.remove('hidden');
}

function closeSummaryModal() {
    document.getElementById('summaryModal').classList.add('hidden');
}

// ===================== 通用功能 =====================
// 格式化日期
function formatDate(dateStr) {
    const date = new Date(dateStr);
    return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
}

// 礼花动效
function fire(){
    for(let i=0;i<12;i++){
        let f = document.createElement('div');
        f.className = 'firework';
        f.style.left = Math.random()*100 + 'vw';
        f.style.top = Math.random()*100 + 'vh';
        f.style.background = ['#ffd700','#ff6b6b','#4cd964','#2196f3'][Math.floor(Math.random()*4)];
        document.body.appendChild(f);
        setTimeout(()=>f.remove(), 800);
    }
}

// 初始化欢迎语
function initWelcome(){
    const h = new Date().getHours();
    let t = `欢迎你，${userNickname}～`;
    if(h>=5&&h<10) t=`☀️ 早上好，${userNickname}！`;
    else if(h<14) t=`☀️ 上午好，${userNickname}！`;
    else if(h<18) t=`🌤 下午好，${userNickname}！`;
    else t=`🌙 晚上好，${userNickname}！`;
    document.getElementById('welcomeText').textContent = t;
}

// 初始化小贴士
function initTip(){
    document.getElementById('tipContent').textContent = tips[Math.floor(Math.random()*tips.length)];
}

// 绑定所有事件
function bindAll(){
    // 交易类型选择
    document.querySelectorAll('.type-btn').forEach(b=>{
        b.onclick = ()=>{
            document.querySelectorAll('.type-btn').forEach(x=>x.classList.remove('active'));
            b.classList.add('active');
        }
    });
    
    // 快捷分类点击
    document.querySelectorAll('.quick-btn').forEach(b=>{
        b.onclick = ()=>{
            document.getElementById('remark').value = b.dataset.name;
        }
    });
    
    // 添加账单
    document.getElementById('addBill').onclick = saveBill;
    
    // 导入导出分享
    document.getElementById('importBtn').onclick = ()=>document.getElementById('fileInput').click();
    document.getElementById('fileInput').onchange = importBill;
    document.getElementById('exportBtn').onclick = exportBill;
    document.getElementById('shareBtn').onclick = share;
    
    // 日期查询
    document.getElementById('searchBtn').onclick = ()=>searchByDate(document.getElementById('searchDate').value);
}

// 保存账单
function saveBill(){
    const type = document.querySelector('.type-btn.active').dataset.type;
    const amount = parseFloat(document.getElementById('amount').value);
    const remark = document.getElementById('remark').value.trim() || "未分类";
    const date = document.getElementById('date').value;
    
    if(!amount || amount<=0) {
        alert("请输入有效的金额！");
        return;
    }
    if(!date) {
        alert("请选择日期！");
        return;
    }
    
    const bill = {
        id:Date.now(), 
        type, 
        amount, 
        remark, 
        date
    };
    
    if(editIndex===-1) {
        bills.unshift(bill); // 新增账单放在最前面
    } else { 
        bills[editIndex] = bill; // 编辑已有账单
        editIndex=-1;
        document.getElementById('addBill').textContent = '添加账单';
    }
    
    // 保存到本地存储
    localStorage.setItem('bills', JSON.stringify(bills));
    
    // 重置表单
    resetForm();
    
    // 更新页面数据
    renderList();
    updateStats();
    updateMonth();
    updateStreak();
    
    // 更新当日查询结果
    searchByDate(date);
    
    // 礼花动效
    fire();
    
    alert("账单保存成功！");
}

// 重置表单
function resetForm(){
    document.getElementById('amount').value = '';
    document.getElementById('remark').value = '';
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
    
    // 重置交易类型为支出
    document.querySelectorAll('.type-btn').forEach(b=>b.classList.remove('active'));
    document.querySelector('[data-type="expense"]').classList.add('active');
}

// 渲染账单列表
function renderList(filter=null){
    const arr = filter || bills;
    const el = document.getElementById('billList');
    
    if(arr.length===0){ 
        el.innerHTML = '<div class="empty-tip">暂无账单记录，添加你的第一笔记账吧！</div>'; 
        return;
    }
    
    let html = '';
    arr.forEach((b,i)=>{
        const idx = filter ? bills.findIndex(x=>x.id===b.id) : i;
        html += `
        <div class="bill-item">
            <div style="display:flex;align-items:center">
                <div>
                    <div style="font-size:15px;color:#333">${b.remark}</div>
                    <div style="font-size:12px;color:#999">${formatDate(b.date)}</div>
                </div>
            </div>
            <div style="font-weight:bold" class="${b.type=='income'?'income':'expense'}">
                ${b.type=='income'?'+':'-' }¥${b.amount.toFixed(2)}
            </div>
            <div style="display:flex;gap:8px">
                <button style="width:28px;height:28px;border:none;border-radius:50%;background:#e3f2fd;color:#2196f3;cursor:pointer" onclick="editBill(${idx})">✏️</button>
                <button style="width:28px;height:28px;border:none;border-radius:50%;background:#ffebee;color:#f44336;cursor:pointer" onclick="deleteBill(${idx})">🗑️</button>
            </div>
        </div>`;
    });
    el.innerHTML = html;
}

// 编辑账单
function editBill(index) {
    const bill = bills[index];
    editIndex = index;
    
    // 填充表单
    document.querySelectorAll('.type-btn').forEach(b=>b.classList.remove('active'));
    document.querySelector(`[data-type="${bill.type}"]`).classList.add('active');
    document.getElementById('amount').value = bill.amount;
    document.getElementById('remark').value = bill.remark;
    document.getElementById('date').value = bill.date;
    
    // 修改按钮文字
    document.getElementById('addBill').textContent = '保存修改';
    
    // 滚动到表单
    window.scrollTo(0, document.querySelector('.form-container').offsetTop - 20);
}

// 删除账单
function deleteBill(index) {
    if (confirm('确定要删除这条账单吗？')) {
        bills.splice(index, 1);
        localStorage.setItem('bills', JSON.stringify(bills));
        renderList();
        updateStats();
        updateMonth();
        updateStreak();
        searchByDate(document.getElementById('searchDate').value);
        alert('账单删除成功！');
    }
}

// 更新总统计数据
function updateStats(){
    let inAll=0, outAll=0, inToday=0, outToday=0;
    const today = new Date().toISOString().split('T')[0];
    
    bills.forEach(b=>{
        if(b.type=='income') inAll+=b.amount; 
        else outAll+=b.amount;
        
        if(b.date==today){
            if(b.type=='income') inToday+=b.amount; 
            else outToday+=b.amount;
        }
    });
    
    document.getElementById('totalIncome').textContent = '¥'+inAll.toFixed(2);
    document.getElementById('totalExpense').textContent = '¥'+outAll.toFixed(2);
    document.getElementById('totalBalance').textContent = '¥'+(inAll-outAll).toFixed(2);
    document.getElementById('todayIncome').textContent = '¥'+inToday.toFixed(2);
    document.getElementById('todayExpense').textContent = '¥'+outToday.toFixed(2);
}

// 更新月度数据
function updateMonth(){
    const now = new Date();
    const month = now.getMonth()+1;
    const year = now.getFullYear();
    let inM=0, outM=0;
    
    bills.forEach(b=>{
        const d = new Date(b.date);
        if(d.getFullYear()==year && d.getMonth()+1==month){
            if(b.type=='income') inM+=b.amount; 
            else outM+=b.amount;
        }
    });
    
    document.getElementById('monthIncome').textContent = '¥'+inM.toFixed(2);
    document.getElementById('monthExpense').textContent = '¥'+outM.toFixed(2);
    document.getElementById('monthBalance').textContent = '¥'+(inM-outM).toFixed(2);
}

// 更新连续打卡天数
function updateStreak(){
    const dateSet = new Set();
    bills.forEach(b=>dateSet.add(b.date));
    const dates = Array.from(dateSet).sort((a,b)=>new Date(b) - new Date(a));
    
    let streak = 0;
    const today = new Date().toISOString().split('T')[0];
    
    if(dates[0] === today){
        streak = 1;
        for(let i=1; i<dates.length; i++){
            const prevDate = new Date(dates[i-1]);
            prevDate.setDate(prevDate.getDate() - 1);
            const prevDateStr = prevDate.toISOString().split('T')[0];
            
            if(prevDateStr === dates[i]){
                streak++;
            } else {
                break;
            }
        }
    }
    
    document.getElementById('streakDay').textContent = streak;
}

// 按日期查询
function searchByDate(d){
    if(!d) {
        alert('请选择查询日期！');
        return;
    }
    
    let inSum=0, outSum=0;
    const filteredList = bills.filter(b=>b.date===d);
    
    filteredList.forEach(b=>{
        if(b.type=='income') inSum+=b.amount; 
        else outSum+=b.amount;
    });
    
    document.getElementById('searchResult').textContent = `${formatDate(d)}：收入 ¥${inSum.toFixed(2)}，支出 ¥${outSum.toFixed(2)}`;
    renderList(filteredList);
}

// 导入账单
function importBill(e){
    const file = e.target.files[0];
    if(!file) return;
    
    // 验证文件类型
    if(file.type !== 'application/json' && !file.name.endsWith('.json')){
        alert('请选择JSON格式的账单文件！');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = ev=>{
        try{
            const importedData = JSON.parse(ev.target.result);
            if(Array.isArray(importedData)){
                // 去重合并
                const existingIds = bills.map(b=>b.id);
                const newBills = importedData.filter(b=>!existingIds.includes(b.id));
                bills = [...bills, ...newBills];
                
                localStorage.setItem('bills', JSON.stringify(bills));
                renderList();
                updateStats();
                updateMonth();
                updateStreak();
                alert(`成功导入 ${newBills.length} 条账单！`);
                
                // 清空文件选择
                document.getElementById('fileInput').value = '';
            } else {
                alert('导入的数据格式不正确！');
            }
        }catch(e){ 
            alert('导入失败：' + e.message); 
        }
    };
    reader.readAsText(file);
}

// 导出账单
function exportBill(){
    if(bills.length===0){
        alert('暂无账单数据可导出！');
        return;
    }
    
    const jsonStr = JSON.stringify(bills, null, 2);
    const blob = new Blob([jsonStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `小七记账_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
    a.click();
    
    // 释放URL
    URL.revokeObjectURL(url);
    alert('账单导出成功！');
}

// 分享账单
function share(){
    if(bills.length===0){
        alert('暂无账单数据可分享！');
        return;
    }
    
    // 生成分享文件
    exportBill();
    alert('已为你生成账单文件，可手动分享给好友～');
}
</script>
</body>
</html>